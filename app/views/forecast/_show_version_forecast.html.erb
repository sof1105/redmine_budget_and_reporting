
<% if not @errors.nil? %>
  <div class="flash error"><%= @errors %></div>
<% end %>

<% if User.current.allowed_to?({:controller => "versions", :action => "update"}, @project) %>
  <%= form_tag({},:id => :edit_version_form) do %>
  <table>
    <tr>
      <td>geplanntes Abschlussdatum:</td>
      <td><%=text_field_tag("version[effective_date]", I18n.l(@version.effective_date)) %></td>
    </tr>
    <tr>
      <td>tatsächliches Abschlussdatum:</td>
      <td><% finished_id = VersionCustomField.where(:name => "Abgeschlossen").first.try(:id) %>
	  <%= text_field_tag("version[custom_field_values][3]",
	      I18n.l(@version.custom_field_value(finished_id).to_date)) %>
      </td>
    </tr>
    <tr>
      <td rowspan="2"><%= submit_tag("Speichern") %></td>
    </tr>
  </table>
  <% end %>
  
  <script>

    $("#version_effective_date").datepicker({
      duration: 0,
      dateFormat: "<%= I18n.t("date.formats.default").sub('%d', 'dd').sub('%m', 'mm').sub('%Y', 'yy') %>"
    });
    <%= finished_id = VersionCustomField.where(:name => "Abgeschlossen").first.try(:id) %>
    $("#version_custom_field_values_<%= finished_id.to_s %>").datepicker({
      duration: 0,
      dateFormat: "<%= I18n.t("date.formats.default").sub('%d', 'dd').sub('%m', 'mm').sub('%Y', 'yy') %>"
    });
    $("#edit_version_form").submit(function(event){
      event.preventDefault();
      $.ajax({url : "<%= url_for({:controller => "versions", :action => "update", :id => @version.id}) %>",
              type : "PUT",
              data : $("#edit_version_form").serialize(),
              error: function(data,)
              success : function(data){
                           $("#floating").html(data);
                         }
              });
    });
  </script>

<% else %>
  <table>
    <tr>
      <td>geplanntes Abschlussdatum:</td>
      <td><%= I18n.l(@version.effective_date) %></td>
    </tr>
    <tr>
      <td>tatsächliches Abschlussdatum:</td>
      <td><%= I18n.l(@version.custom_field_value(VersionCustomField.where(:name => "Abgeschlossen").first.try(:id)).to_date)%></td>
    </tr>
  </table>
<% end %>
 

  Bisherige Prognosen:
  
  <table class="forecast small">
    <tr>
      <th>Prognose</th>
      <th>erstellt am</th>
      <th></th>
  <% @forecasts.each do |forecast| %>
    <tr>
      <td><%= I18n.l(forecast.forecast_date) %></td>
      <td><%= I18n.l(forecast.planned_date) %></td>
      <td>
      <% if User.current.allowed_to?({:controller => "forecast", :action => "delete_versiondate_forecast"}, @project) %>
        <a onclick="reload_dialog('<%= url_for({:controller => "forecast", :action => "delete_versiondate_forecast",
                                                :project_id => @project.id, :forecast_id => forecast.id}) %>')" href="#">
          <span class="icon icon-del"/>löschen?</a>
      <% end %>
      </td>
    </tr>
  <% end %>
  
  <%# add new forecast if user is allowed_to %>
  <% if User.current.allowed_to?({:controller => "forecast", :action => "new_versiondate_forecast"}, @project) %>
    <tr>
      <%= form_tag({}, :id =>"new_forecast_form") do %>
        <td><%= text_field_tag(:forecast_date, nil, :size => 10) %></td>
        <td><%= text_field_tag(:planned_date, nil, :size => 10) %></td>
        <td><a href="#" onClick="add_forecast()"><span class="icon icon-add"/>hinzufügen</a></td>
      <% end %>
    </tr>
    </table>

    <script type="text/javascript">
      //transform inputs into datepicker
      $("#forecast_date").datepicker({
        duration: 0,
        dateFormat: "<%= I18n.t("date.formats.default").sub('%d', 'dd').sub('%m', 'mm').sub('%Y', 'yy') %>"
      });
      $("#planned_date").datepicker({
        duration: 0,
        dateFormat: "<%= I18n.t("date.formats.default").sub('%d', 'dd').sub('%m', 'mm').sub('%Y', 'yy') %>"
      });
      $("#planned_date").datepicker("setDate", "<%= I18n.l(Date.today) %>");
    
      // add new forecast via ajax post
      function add_forecast(){
        $.post("<%= url_for({:controller => "forecast", :action => "new_versiondate_forecast",
                                  :version_id => @version.id, :project_id => @project.id}) %>",
              $("#new_forecast_form").serialize(),
              function(data){
                $("#floating").html(data);
              });
      };
    </script>

  <% else %>
    </table>
  <% end %>
